**Documentación del Proyecto: Criteria Custom Attributes**

**Introducción**

Este proyecto es una Prueba de Concepto (POC) para aplicar filtros dinámicos en vistas de bases de datos usando el patrón Specification con JPA Criteria en un entorno de Spring Boot. La aplicación interactúa con una base de datos Oracle y expone endpoints para realizar consultas sobre vistas de usuarios y permisos, con la capacidad de aplicar filtros personalizados en los atributos.

-----
**Requisitos Previos**

1. **Java**: Asegúrate de tener Java 17 o superior instalado.
1. **Maven**: Necesitarás Maven para manejar las dependencias y construir el proyecto.
1. **Oracle Database**: Este proyecto está configurado para conectarse a una base de datos Oracle. Se recomienda configurar un contenedor de Oracle en Docker o utilizar una base de datos localmente.
1. **Postman**: Para realizar pruebas en los endpoints proporcionados.
-----
**Configuración del Entorno**

**Clonación del Repositorio**

Clona el repositorio desde GitHub:

bash

git clone https://github.com/ZefferX/Criteria-custom-attributes.git

cd Criteria-custom-attributes

**Configuración de la Base de Datos**

1. **Crear las Tablas y Vistas en Oracle**

   Copia y ejecuta el siguiente script SQL en tu base de datos Oracle:

`	`-- Tabla de usuarios

CREATE TABLE app\_user (

`    `id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

`    `name VARCHAR2(100) NOT NULL,

`    `active NUMBER(1) NOT NULL

);

-- Tabla de oficinas

CREATE TABLE offices (

`    `id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

`    `name VARCHAR2(100) NOT NULL

);

-- Tabla de permisos

CREATE TABLE permissions (

`    `id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

`    `name VARCHAR2(100) NOT NULL

);

-- Tabla de relación entre usuarios y oficinas

CREATE TABLE user\_office (

`    `user\_id NUMBER,

`    `office\_id NUMBER,

`    `FOREIGN KEY (user\_id) REFERENCES app\_user(id),

`    `FOREIGN KEY (office\_id) REFERENCES offices(id)

);

-- Tabla de relación entre usuarios y permisos

CREATE TABLE user\_permissions (

`    `user\_id NUMBER,

`    `permission\_id NUMBER,

`    `FOREIGN KEY (user\_id) REFERENCES app\_user(id),

`    `FOREIGN KEY (permission\_id) REFERENCES permissions(id)

);

-- Datos de ejemplo para la tabla de usuarios

INSERT INTO app\_user (name, active) VALUES ('Alice', 1);

INSERT INTO app\_user (name, active) VALUES ('Bob', 1);

INSERT INTO app\_user (name, active) VALUES ('Charlie', 1);

INSERT INTO app\_user (name, active) VALUES ('Diana', 1);

INSERT INTO app\_user (name, active) VALUES ('Evelyn', 1);

INSERT INTO app\_user (name, active) VALUES ('Frank', 1);

-- Datos de ejemplo para la tabla de oficinas

INSERT INTO offices (name) VALUES ('Finance');

INSERT INTO offices (name) VALUES ('HR');

INSERT INTO offices (name) VALUES ('IT');

INSERT INTO offices (name) VALUES ('Customer Support');

INSERT INTO offices (name) VALUES ('Marketing');

-- Datos de ejemplo para la tabla de permisos

INSERT INTO permissions (name) VALUES ('READ');

INSERT INTO permissions (name) VALUES ('WRITE');

INSERT INTO permissions (name) VALUES ('ADMIN');

INSERT INTO permissions (name) VALUES ('USER\_MANAGEMENT');

INSERT INTO permissions (name) VALUES ('EXPORT\_DATA');

-- Datos de ejemplo para la tabla de relación entre usuarios y oficinas

INSERT INTO user\_office (user\_id, office\_id) VALUES (1, 1);

INSERT INTO user\_office (user\_id, office\_id) VALUES (2, 4);

INSERT INTO user\_office (user\_id, office\_id) VALUES (3, 3);

INSERT INTO user\_office (user\_id, office\_id) VALUES (4, 4);

INSERT INTO user\_office (user\_id, office\_id) VALUES (5, 1);

INSERT INTO user\_office (user\_id, office\_id) VALUES (6, 3);

-- Datos de ejemplo para la tabla de relación entre usuarios y permisos

INSERT INTO user\_permissions (user\_id, permission\_id) VALUES (1, 1);

INSERT INTO user\_permissions (user\_id, permission\_id) VALUES (2, 2);

INSERT INTO user\_permissions (user\_id, permission\_id) VALUES (3, 3);

INSERT INTO user\_permissions (user\_id, permission\_id) VALUES (4, 4);

INSERT INTO user\_permissions (user\_id, permission\_id) VALUES (5, 5);

INSERT INTO user\_permissions (user\_id, permission\_id) VALUES (6, 1);

-- Vista de relaciones entre usuarios y oficinas

CREATE OR REPLACE VIEW user\_offices\_view AS

SELECT

`    `ROWNUM AS id,

`    `u.id AS user\_id,

`    `u.name AS user\_name,

`    `u.active AS user\_active,

`    `o.id AS office\_id,

`    `o.name AS office\_name

FROM

`    `app\_user u

JOIN user\_office uo ON u.id = uo.user\_id

JOIN offices o ON uo.office\_id = o.id;

-- Vista de relaciones entre usuarios y permisos

CREATE OR REPLACE VIEW user\_permissions\_view AS

SELECT

`    `ROWNUM AS id,

`    `u.id AS user\_id,

`    `u.name AS user\_name,

`    `u.active AS user\_active,

`    `p.id AS permission\_id,

`    `p.name AS permission\_name

FROM

`    `app\_user u

JOIN user\_permissions up ON u.id = up.user\_id

JOIN permissions p ON up.permission\_id = p.id;

### **Configuración de la Aplicación**
Configura las credenciales de conexión a la base de datos en application.yml:

server:

`  `port: 9500

spring:

`  `datasource:

`    `url: jdbc:oracle:thin:@localhost:1521/XE

`    `username: system

`    `password: example

`    `driver-class-name: oracle.jdbc.OracleDriver

`  `jpa:

`    `hibernate:

`      `ddl-auto: update

`    `show-sql: true

`    `database-platform: org.hibernate.dialect.OracleDialect
### **Compilar y Ejecutar el Proyecto**
**Endpoints de la API**

La API expone varios endpoints para realizar consultas en las vistas de usuarios y permisos.

**Endpoint para Usuarios por Oficinas**

1. **Obtener todas las oficinas de los usuarios**

   **URL**: /api/user-office
   **Método**: GET
   **Descripción**: Devuelve todas las relaciones de usuarios con sus oficinas.

1. **Buscar por ID de Vista de Oficina**

   **URL**: /api/user-office/{id}
   **Método**: GET
   **Descripción**: Devuelve la relación específica de usuario y oficina por el ID de la vista.
### ` `**A 1. Filtro de Offices**
**Request URL:** http://localhost:9500/api/user-office/filter?userName=C&officeName=Cus

**Explicación:**

- Filtra los resultados donde userName contiene "C" y officeName contiene "Cus".

**Expected Result:**

json

[

`    `{

`        `"id": 2,

`        `"user\_id": 2,

`        `"user\_name": "Charlie",

`        `"user\_active": 1,

`        `"office\_id": 4,

`        `"office\_name": "Customer Support"

`    `}

]

**Endpoint para Usuarios por Permisos**

1. **Obtener todas las relaciones de permisos de usuarios**

   **URL**: /api/user-permission
   **Método**: GET
   **Descripción**: Devuelve todas las relaciones entre usuarios y permisos.

1. **Buscar Usuarios con un Permiso Específico**

   **URL**: /api/user-permission/permission/{permissionId}
   **Método**: GET
   **Descripción**: Devuelve los usuarios que tienen un permiso específico basado en permissionId.
### **Filtro de Permissions**
**Endpoint:** GET http://localhost:9500/api/user-permission/filter

**Request URL:** <http://localhost:9500/api/user-permission/filter?userName=Cha&permissionName=EXPORT>

**Explicación:**

- Filtra los resultados donde userName contiene "Cha" y permissionName contiene "EXPORT".

**Expected Result:**[

`    `{

`        `"id": 3,

`        `"user\_id": 3,

`        `"user\_name": "Charlie",

`        `"user\_active": 1,

`        `"permission\_id": 3,

`        `"permission\_name": "EXPORT\_DATA"

`    `}

]
### **Explicación para Pruebas en Postman**
1. **Configuración de Postman:**
   1. Usa el método GET para ambos endpoints.
   1. Asegúrate de que los parámetros userName y officeName o permissionName se incluyan como Query Params en la URL.
1. **Ejemplo de Consulta para user-office Filter:**
   1. En Query Params:
      1. userName = C
      1. officeName = Cus
   1. Resultado esperado: Deberías ver un objeto JSON con información del usuario "Charlie" y la oficina "Customer Support".
1. **Ejemplo de Consulta para user-permission Filter:**
   1. En Query Params:
      1. userName = Cha
      1. permissionName = EXPORT
   1. Resultado esperado: Deberías ver un objeto JSON con información del usuario "Charlie" y el permiso "EXPORT\_DATA".

**¿Como agregar un nuevo atributo al criteria?**
### **1. Modificación del DTO (OfficeFilterDTO)**
Agrega el nuevo campo nickname al OfficeFilterDTO. Como estás usando record y @Builder, solo necesitas añadir el nuevo atributo en la definición.

**Código actualizado de OfficeFilterDTO:**

@Builder

public record OfficeFilterDTO(

`        `String officeName,

`        `String userName,

`        `String nickname // Nuevo atributo añadido

) {}

-----
### **2. Modificación de la Clase Specification (OfficeSpecification)**
Agrega la condición del nuevo atributo nickname en el método getSpecifications para que se aplique el filtro si nickname no es null.

**Código actualizado de OfficeSpecification:**

@Component

public class OfficeSpecification {

`    `public static Specification<UserOfficeView> getSpecifications(OfficeFilterDTO filterDTO) {

`        `Specification<UserOfficeView> spec = Specification.where(null);

`        `if (filterDTO.officeName() != null) {

`            `spec = spec.and((root, query, cb) ->

`                    `cb.like(root.get("OFFICE\_NAME"), filterDTO.officeName() + "%"));

`        `}

`        `if (filterDTO.userName() != null) {

`            `spec = spec.and((root, query, cb) ->

`                    `cb.like(root.get("USER\_NAME"), filterDTO.userName() + "%"));

`        `}

`        `// Nuevo filtro para el atributo "nickname"

`        `if (filterDTO.nickname() != null) {

`            `spec = spec.and((root, query, cb) ->

`                    `cb.like(root.get("NICKNAME"), filterDTO.nickname() + "%"));

`        `}

`        `return spec;

`    `}

}

-----
### **3. Modificación en el Modelo de Vista (UserOfficeView)**
Agrega el nuevo campo nickname en la entidad UserOfficeView para que se pueda mapear a la columna correspondiente en la vista de la base de datos user\_offices\_view.

**Código actualizado de UserOfficeView:**

@Entity

@Immutable

@Table(name = "user\_offices\_view")

@Data

public class UserOfficeView {

`    `@Id

`    `private Integer id;

`    `private Integer USER\_ID;

`    `private String USER\_NAME;

`    `private String OFFICE\_NAME;

`    `// Nuevo campo añadido

`    `private String NICKNAME;

}

**Nota**: Asegúrate de que el atributo NICKNAME esté presente en la vista user\_offices\_view en la base de datos.

-----
### **Actualización en la Vista de la Base de Datos (user\_offices\_view)**
Si el campo NICKNAME no existe en la vista de la base de datos user\_offices\_view, actualiza la vista para incluir este campo. Aquí tienes un ejemplo de cómo podría verse la vista actualizada:

CREATE OR REPLACE VIEW user\_offices\_view AS

SELECT 

`    `ROWNUM AS id,

`    `u.id AS user\_id,

`    `u.name AS user\_name,

`    `u.active AS user\_active,

`    `o.id AS office\_id,

`    `o.name AS office\_name,

`    `u.nickname AS nickname -- Nuevo campo agregado

FROM 

`    `app\_user u

JOIN 

`    `user\_office uo ON u.id = uo.user\_id

JOIN 

`    `offices o ON uo.office\_id = o.id;

-----
### **Resumen**
1. **Modificaste OfficeFilterDTO** para agregar el nuevo campo nickname.
1. **Actualizaste OfficeSpecification** para incluir el filtro por nickname.
1. **Agregaste el atributo nickname en UserOfficeView** para mapear la columna correspondiente.
1. **Aseguraste que la vista user\_offices\_view en la base de datos incluya el campo nickname**.

Con estos cambios, podrás filtrar resultados utilizando el campo nickname en los criterios de búsqueda.
